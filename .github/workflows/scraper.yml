name: YTS 2160p Movie Scraper with Real-Debrid

on:
  schedule:
    # Run every hour at the top of the hour
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [ main, master ]
    paths:
      - 'yts_scraper/**'
      - 'auto_scraper_2160p.py'
      - 'real_debrid_cached_uploader.py'
      - '.github/workflows/scraper.yml'

jobs:
  scrape-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests tqdm fake-useragent
        
    - name: Create output directories
      run: |
        mkdir -p Downloads/2160p_Movies
        mkdir -p logs
        
    - name: Run 2160p movie scraper
      run: |
        python auto_scraper_2160p.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        
    - name: Upload cached torrents to Real-Debrid
      continue-on-error: true
      run: |
        if [ -z "$REAL_DEBRID_API_KEY" ]; then
          echo "‚ö†Ô∏è  REAL_DEBRID_API_KEY not set, skipping Real-Debrid upload"
          echo "üí° To enable Real-Debrid integration, add your API key as a GitHub secret"
          exit 0
        fi
        echo "üîç Checking for cached torrents on Real-Debrid..."
        echo "üìÇ Torrent directory: $TORRENT_DIR"
        echo "üî¢ Max uploads per run: $MAX_CACHED_UPLOADS_PER_RUN"
        
        # Check if the script exists
        if [ ! -f "real_debrid_cached_uploader.py" ]; then
          echo "‚ùå real_debrid_cached_uploader.py not found"
          exit 1
        fi
        
        # Test script syntax first
        echo "üîç Testing script syntax..."
        python -m py_compile real_debrid_cached_uploader.py || {
          echo "‚ùå Script has syntax errors"
          exit 1
        }
        
        # Run the cached uploader with error handling
        echo "üöÄ Running cached uploader..."
        python real_debrid_cached_uploader.py || {
          echo "‚ùå Real-Debrid cached uploader failed with exit code $?"
          exit 1
        }
      env:
        REAL_DEBRID_API_KEY: ${{ secrets.REAL_DEBRID_API_KEY }}
        TORRENT_DIR: Downloads/2160p_Movies
        MAX_CACHED_UPLOADS_PER_RUN: 100

    - name: Upload scraped torrents as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: 2160p-magnets-${{ github.run_number }}
        path: |
          Downloads/2160p_Movies/**/*.magnet
          Downloads/2160p_Movies/**/*.jpg
        retention-days: 30
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scraper-logs-${{ github.run_number }}
        path: logs/
        retention-days: 7
        
    - name: Create release with torrents (weekly)
      if: github.event.schedule == '0 0 * * 0'  # Only on Sunday at midnight
      uses: softprops/action-gh-release@v1
      with:
        tag_name: weekly-release-${{ github.run_number }}
        name: Weekly 2160p Movies - ${{ github.run_number }}
        body: |
          üé¨ **Weekly 2160p Movie Collection**
          
          This release contains high-quality 2160p (4K/UHD) movie magnet links scraped from YTS.
          
          **üìä Stats:**
          - Run #${{ github.run_number }}
          - Date: ${{ github.event.head_commit.timestamp }}
          - Quality: 2160p only
          - Rating: All ratings
          - Year Range: All years
          
          **üìÅ Organization:**
          Files are organized by movie name and year: "Movie Name (Year)/"
          
          **üß≤ Magnet Links:**
          These magnet links are automatically uploaded to Real-Debrid for instant streaming.
          
          ‚≠ê Star this repo to get notified of new releases!
        files: |
          Downloads/2160p_Movies/**/*.magnet
          Downloads/2160p_Movies/**/*.jpg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean up old artifacts (keep last 10 runs)
      uses: geekyeggo/delete-artifact@v2
      if: always()
      continue-on-error: true
      with:
        name: 2160p-magnets-*
        useGlob: true
        failOnError: false
        
    - name: Clean up old log artifacts
      uses: geekyeggo/delete-artifact@v2
      if: always()
      continue-on-error: true
      with:
        name: scraper-logs-*
        useGlob: true
        failOnError: false